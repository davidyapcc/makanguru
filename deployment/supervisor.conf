###############################################################################
# MakanGuru - Supervisor Configuration for Laravel Queue Workers
#
# This configuration manages Laravel queue workers as background processes.
# Supervisor ensures queue workers restart automatically if they fail.
#
# Installation:
# 1. Copy this file to /etc/supervisor/conf.d/makanguru.conf
# 2. Update the user, directory paths, and number of processes as needed
# 3. Reload supervisor: supervisorctl reread && supervisorctl update
# 4. Start workers: supervisorctl start makanguru-worker:*
###############################################################################

[program:makanguru-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/makanguru/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600 --timeout=300
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/makanguru/storage/logs/worker.log
stopwaitsecs=3600

###############################################################################
# Configuration Explanation:
#
# process_name: Unique name for each worker process
# command: Laravel queue worker command
#   - queue:work redis: Use Redis connection for queues
#   - --sleep=3: Sleep for 3 seconds when no jobs available
#   - --tries=3: Retry failed jobs up to 3 times
#   - --max-time=3600: Restart worker after 1 hour (prevents memory leaks)
#   - --timeout=300: Job timeout of 5 minutes
#
# autostart: Start workers automatically when Supervisor starts
# autorestart: Restart workers if they die
# stopasgroup: Send stop signal to the entire process group
# killasgroup: Send kill signal to the entire process group
# user: Run workers as www-data user (same as PHP-FPM)
# numprocs: Number of worker processes to spawn (adjust based on load)
# redirect_stderr: Redirect error output to stdout
# stdout_logfile: Log file location
# stopwaitsecs: Wait time before forcefully killing workers (in seconds)
###############################################################################

###############################################################################
# Optional: Horizon Configuration (if using Laravel Horizon instead)
#
# [program:makanguru-horizon]
# process_name=%(program_name)s
# command=php /var/www/makanguru/artisan horizon
# autostart=true
# autorestart=true
# user=www-data
# redirect_stderr=true
# stdout_logfile=/var/www/makanguru/storage/logs/horizon.log
# stopwaitsecs=3600
###############################################################################

###############################################################################
# Optional: Schedule Runner (Laravel Scheduler)
#
# Note: It's generally better to use cron for the scheduler.
# Add this to crontab instead: crontab -e -u www-data
# * * * * * cd /var/www/makanguru && php artisan schedule:run >> /dev/null 2>&1
#
# But if you prefer Supervisor:
#
# [program:makanguru-scheduler]
# process_name=%(program_name)s
# command=php /var/www/makanguru/artisan schedule:work
# autostart=true
# autorestart=true
# user=www-data
# redirect_stderr=true
# stdout_logfile=/var/www/makanguru/storage/logs/scheduler.log
###############################################################################
